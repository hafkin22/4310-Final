<html>
    <head>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">

        <style>
            body {
                font-family: "Space Grotesk", sans-serif;
                display: flex;
                flex-direction: column;
                align-items: center;
                margin: 0px;
            }

            .title_header {
                width: 100%;
                text-align: center;
                color: white;
                background-color: #0136a8;
            }

            form {
                display: flex;
                flex-direction: column;
                width: 800px;
                font-size: 20px;
                font-family: "Space Grotesk", sans-serif;
            }

            form input {
                width: 150px;
                font-size: 20px;
                font-family: "Space Grotesk", sans-serif;
            }

            form button {
                width: 300px;
                font-size: 20px;
                font-weight: bold;
                font-family: "Space Grotesk", sans-serif;
                background-color: #0136a8;
                color: white;
                border: none;
                padding: 10px;
                border-radius: 5px;
                cursor: pointer;
                transition: background-color 0.2s ease;
            }

            form button:hover {
                background-color: #002d87;
            }

            form label {
                margin-top: 20px;
            }

            form .form_section {
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: center;
                margin-top: 15px;
            }

            form .form_section label {
                margin-top: 0px;
                font-size: 20px;
            }

            form .form_section select {
                margin-top: 0px;
                margin-left: 5px;
                font-size: 20px;
                font-family: "Space Grotesk", sans-serif;
            }

            form .form_section input {
                margin-top: 0px;
                margin-left: 5px;
                font-size: 20px;
            }

            form .specific_section {
                margin-top: 20px;
            }

            form .specific_section label {
                margin-top: 20px;
            }

            form .specific_section select {
                font-size: 20px;
            }

            .safety {
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .safety h2 {
                text-align: center;
            }

            .safety .cost_header, .safety_header {
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: center;
                gap: 5px;
            }

            .safety .cost_component_div {
                width: 450px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                padding: 10px;
                border-radius: 4px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            }

            .safety svg {
                border-radius: 4px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                padding: 5px;
            }

            svg text {
                font-family: "Space Grotesk", sans-serif;
            }

            .cost_component_div img {
                height: 100px;
                width: auto;
                object-fit: contain;
                margin: 0 auto;
            }

            .safety .cost_component_div p{
                text-align: center;
                margin-bottom: 0px;
            }

            .safety .cost_final {
                margin-top: 30px;
            }

            .safety .plus_sign {
                font-size: 35px;
            }

            .safety .section_intro {
                width: 700px;
                font-size: 20px;
            }

            .accident_bar_div {
                display: flex;
                justify-content: center;
            }

            .safety_value_boxes p, h3 {
                text-align: center;
            }

            .safety_value_boxes h3 {
                font-size: 50px;
            }

            .safety_value_boxes p {
                font-size: 30px;
            }

            .safety_value_boxes .safety_metric {
                font-size: 70px;
                font-weight: bolder;
                margin-top: 30px;
                margin-bottom: 30px;
            }

            .safety_button {
                text-align: center;
                margin-top: 20px;
            }

            .safety_button button {
                font-size: 20px;
                padding: 10px 20px;
                font-weight: bold;
                font-family: "Space Grotesk", sans-serif;
                background-color: #0136a8;
                color: white;
                border: none;
                padding: 10px;
                border-radius: 5px;
                cursor: pointer;
                transition: background-color 0.2s ease;
            }

            .safety_button button:hover {
                background-color: #002d87;
            }


            .safety_restart_button {
                display: flex;
                flex-direction: row;
                align-items: center;
                margin-top: 20px;
                margin-bottom: 50px;
                cursor: pointer;
            }

            .safety_restart_button img {
                margin-right: 5px;
            }
        </style>
    </head>
    <body id="body">

        <header class="title_header">
            <h1>Do you drive from LI to NYC for work? Consider the risks and costs of your commute.</h1>
        </header>

        <script>
            const body = d3.select("#body");
            const lirrZones = {
                1: ['Atlantic Terminal', 'Nostrand Avenue', 'East New York', 'Long Island City', 'Hunterspoint Avenue', 'Forest Hills', 'Woodside', 'Kew Gardens', 'Penn Station', 'Grand Central', 'Mets-Willets Point'], 
                3: ['Jamaica', 'Locust Manor', 'Laurelton', 'Rosedale', 'St. Albans', 'Hollis', 'Queens Village', 'Flushing', 'Murray Hill', 'Broadway', 'Auburndale', 'Bayside', 'Douglaston', 'Little Neck'], 
                4: ['Gibson', 'Hewlett', 'Woodmere', 'Cedarhurst', 'Lawrence', 'Inwood', 'Far Rockaway', 'Lynbrook', 'West Hempstead', 'Valley Stream', 'Westwood', 'Malverne', 'Lakeview', 'Hempstead Gardens', 'Belmont Park', 'Stewart Manor', 'Nassau Boulevard', 'Garden City', 'County Life Press', 'Hempstead', 'Elmont-UBS', 'Bellerose', 'Floral Park', 'New Hyde Park', 'Merillon Avenue', 'Mineola', 'East Williston', 'Great Neck', 'Manhasset', 'Plandome', 'Port Washington'], 
                7: ['Centre Avenue', 'East Rockaway', 'Oceanside', 'Island Park', 'Long Beach', 'Rockville Centre', 'Baldwin', 'Freeport', 'Merrick', 'Bellmore', 'Wantagh', 'Seaford', 'Massapequa', 'Massapequa Park', 'Carle Place', 'Westbury', 'Bethpage', 'Farmingdale', 'Hicksville', 'Syosset', 'Albertson', 'Roslyn', 'Greenvale', 'Glen Head', 'Sea Cliff', 'Glen Street', 'Glen Cove', 'Locust Valley', 'Oyster Bay'], 
                9: ['Amityville', 'Copiague', 'Lindenhurst', 'Babylon', 'Pinelawn', 'Wyandanch', 'Deer Park', 'Cold Spring Harbor', 'Huntington', 'Greenlawn', 'Northport'], 
                10: ['Bay Shore', 'Islip', 'Great River', 'Oakdale', 'Sayville', 'Patchogue', 'Brentwood', 'Central Islip', 'Ronkonkoma', 'Medford', 'Kings Park', 'Smithtown', 'St. James', 'Stony Brook', 'Port Jefferson'], 
                12: ['Bellport', 'Mastic-Shirley', 'Speonk', 'Yaphank'], 
                14: ['Westhampton', 'Hampton Bays', 'Southampton', 'Bridgehampton', 'East Hamption', 'Amagansett', 'Montauk', 'Riverhead', 'Mattituck', 'Southold', 'Greenport']
            }

            const lirrZones_reversed = {}

            for (const [zone, stations] of Object.entries(lirrZones)) {
                stations.forEach(station => {
                    lirrZones_reversed[station] = parseInt(zone);
                });
            }

            // Mile distances between each LIRR station and Penn Station
            const stationDistance = {
                'Atlantic Terminal': 5.5,
                'Nostrand Avenue': 7.7,
                'East New York': 13.5,
                'Long Island City': 4.1,
                'Hunterspoint Avenue': 3.1,
                'Forest Hills': 9.8,
                'Woodside': 5.5,
                'Kew Gardens': 12.6,
                'Penn Station': 0,
                'Grand Central': 1.3,
                'Mets-Willets Point': 11.5,

                'Jamaica': 13.3,
                'Locust Manor': 16.8,
                'Laurelton': 17.8,
                'Rosedale': 22.9,
                'St. Albans': 15.8,
                'Hollis': 15.1,
                'Queens Village': 16.8,
                'Flushing': 10.7,
                'Murray Hill': 12.6,
                'Broadway': 13.3,
                'Auburndale': 14.0,
                'Bayside': 14.6,
                'Douglaston': 16.0,
                'Little Neck': 16.4,

                'Gibson': 21.3,
                'Hewlett': 22.0,
                'Woodmere': 21.5,
                'Cedarhurst': 20.8,
                'Lawrence': 20.9,
                'Inwood': 21.0,
                'Far Rockaway': 21.5,
                'Lynbrook': 21.9,
                'West Hempstead': 25.4,
                'Valley Stream': 20.4,
                'Westwood': 24.2,
                'Malverne': 24.3,
                'Lakeview': 25.0,
                'Hempstead Gardens': 26.1,
                'Belmont Park': 18.8,
                'Stewart Manor': 21.0,
                'Nassau Boulevard': 21.8,
                'Garden City': 22.5,
                'County Life Press': 27.4,
                'Hempstead': 26.9,
                'Elmont-UBS': 18.0,
                'Bellerose': 18.8,
                'Floral Park': 18.3,
                'New Hyde Park': 19.7,
                'Merillon Avenue': 20.8,
                'Mineola': 22.6,
                'East Williston': 22.9,
                'Great Neck': 18.5,
                'Manhasset': 19.2,
                'Plandome': 23.1,
                'Port Washington': 23.5,

                'Centre Avenue': 26.3,
                'East Rockaway': 26.8,
                'Oceanside': 27.3,
                'Island Park': 30.3,
                'Long Beach': 26.4,
                'Rockville Centre': 26.1,
                'Baldwin': 28.7,
                'Freeport': 32.6,
                'Merrick': 32.8,
                'Bellmore': 33.8,
                'Wantagh': 34.6,
                'Seaford': 35.7,
                'Massapequa': 36.5,
                'Massapequa Park': 37.4,
                'Carle Place': 25.3,
                'Westbury': 26.2,
                'Bethpage': 30.5,
                'Farmingdale': 35.9,
                'Hicksville': 29.3,
                'Syosset': 30.4,
                'Albertson': 21.1,
                'Roslyn': 21.1,
                'Greenvale': 23.9,
                'Glen Head': 25.3,
                'Sea Cliff': 27.0,
                'Glen Street': 27.1,
                'Glen Cove': 28.0,
                'Locust Valley': 29.7,
                'Oyster Bay': 33.3,

                'Amityville': 39.6,
                'Copiague': 39.9,
                'Lindenhurst': 41.9,
                'Babylon': 45.8,
                'Pinelawn': 36.4,
                'Wyandanch': 38.6,
                'Deer Park': 44.3,
                'Cold Spring Harbor': 33.3,
                'Huntington': 35.6,
                'Greenlawn': 42.1,
                'Northport': 43.0,

                'Bay Shore': 48.0,
                'Islip': 50.4,
                'Great River': 52.2,
                'Oakdale': 54.4,
                'Sayville': 54.3,
                'Patchogue': 56.5,
                'Brentwood': 44.8,
                'Central Islip': 46.6,
                'Ronkonkoma': 50.5,
                'Medford': 56.1,
                'Kings Park': 46.6,
                'Smithtown': 48.4,
                'St. James': 51.6,
                'Stony Brook': 56.3,
                'Port Jefferson': 62.0,

                'Bellport': 60.8,
                'Mastic-Shirley': 64.4,
                'Speonk': 74.0,
                'Yaphank': 60.4,

                'Westhampton': 76.9,
                'Hampton Bays': 56.5,
                'Southampton': 89.8,
                'Bridgehampton': 95.0,
                'East Hamption': 102.0,
                'Amagansett': 105.0,
                'Montauk': 117.0,
                'Riverhead': 75.1,
                'Mattituck': 85.6,
                'Southold': 93.0,
                'Greenport': 97.3
            };

            console.log(stationDistance);

            const zoneToCityFares = {
                1: {'Monthly': 165.00, 'Weekly': 65.00, 'Ten-Trip Peak': 92.50, 'Ten-Trip Off-Peak': 57.50, 'One-Way Peak': 9.25, 'One-Way Off-Peak': 6.75}, 
                3: {'Monthly': 198.00, 'Weekly': 78.25, 'Ten-Trip Peak': 112.50, 'Ten-Trip Off-Peak': 70.25, 'One-Way Peak': 11.25, 'One-Way Off-Peak': 8.25}, 
                4: {'Monthly': 253.00, 'Weekly': 90.00, 'Ten-Trip Peak': 130.00, 'Ten-Trip Off-Peak': 83.00, 'One-Way Peak': 13.00, 'One-Way Off-Peak': 9.75}, 
                7: {'Monthly': 287.00, 'Weekly': 102.00, 'Ten-Trip Peak': 145.00, 'Ten-Trip Off-Peak': 91.50, 'One-Way Peak': 14.50, 'One-Way Off-Peak': 10.75}, 
                9: {'Monthly': 341.00, 'Weekly': 121.25, 'Ten-Trip Peak':175.00, 'Ten-Trip Off-Peak': 110.50, 'One-Way Peak': 17.50, 'One-Way Off-Peak': 13.00}, 
                10: {'Monthly': 378.00, 'Weekly': 134.50, 'Ten-Trip Peak': 205.00, 'Ten-Trip Off-Peak': 129.75, 'One-Way Peak': 20.50, 'One-Way Off-Peak': 15.25}, 
                12: {'Monthly': 433.00, 'Weekly': 154.00, 'Ten-Trip Peak': 245.00, 'Ten-Trip Off-Peak': 155.25, 'One-Way Peak': 24.50, 'One-Way Off-Peak': 18.25}, 
                14: {'Monthly': 468.00, 'Weekly': 166.25, 'Ten-Trip Peak': 317.50, 'Ten-Trip Off-Peak': 199.75, 'One-Way Peak': 31.75, 'One-Way Off-Peak': 23.50}
            }

            // Risk-related
            const safety_visualizations = d3.select("#safety");

            const requestData = async () => {

                // Get accident datasets 
                let collisions_crashes = await d3.csv("crash_data_date_time.csv");

                collisions_crashes.forEach(d => {
                    d["CRASH.DATE"] = new Date(`${d["CRASH.DATE"]} ${d["CRASH.TIME"]}`);
                });

                collisions_crashes = collisions_crashes.filter(d => d["CRASH.DATE"].getFullYear() === 2024);

                // Populate the form with make and model values
                const gasMileage = await d3.csv("vehicles.csv");

                const lookup = {};

                gasMileage.forEach(d => {
                    const year = d.year;
                    const make = d.make;
                    const model = d.baseModel;
                    const mpg = d.comb08;

                    if (!lookup[year]) {
                        lookup[year] = {};
                    }

                    if (!lookup[year][make]) {
                        lookup[year][make] = {};
                    }

                    const mpgValue = parseFloat(mpg);
                    
                    if (!lookup[year][make][model]) {
                        lookup[year][make][model] = [];
                    }
                    lookup[year][make][model].push(mpgValue);
                });

                // Get all LIRR station names
                const allStations = Object.values(lirrZones).flat().sort();

                // Get all years of vehicles in lookup
                const years = Array.from(new Set(gasMileage.map(d => d.year))).sort((a, b) => b - a);
                

                // REPORT GENERATION FUNCTIONS
                function cost_section (responses) {

                    body.selectAll('div').remove();

                    const safety_visualizations = body.append('div').attr('id', 'safety').attr('class', 'safety');

                    safety_visualizations.html("");

                    const cost_header = safety_visualizations.append('div').attr('class', 'cost_header');

                    cost_header.append('img').attr('src', 'images/dollar-symbol.png').style('height', '38px');
                    cost_header.append("h1").text("Section 2: Cost");
                    cost_header.append('img').attr('src', 'images/dollar-symbol.png').style('height', '38px');

                    safety_visualizations.append("p").attr('class', 'section_intro').text("Depending on where you live, driving to work can definitely be the more convenient commuting option. But when was the last time you thought about how much that convenience costed you? Here is a refreshed breakdown:");

                    // Car usage cost calculation
                    let gas_mileage = lookup[responses["car_year_response"]][responses["car_make_response"]][responses["car_model_response"]][0];

                    let work_distance = stationDistance[responses['lirr_response']];

                    const avg_gas_price = 3.30;

                    let gas_spending_year = ((work_distance*responses['dpw_response']*2)/gas_mileage)*avg_gas_price*52;

                    let parking_spending_year = Math.min(570*12, responses['dpw_response']*20*52);

                    let parking_mode = "";
                    if (parking_spending_year == 570*12) {
                        parking_mode = "Monthly Parking Pass ($570/Month) X 12";
                    } else {
                        parking_mode = "Daily Parking Pass ($20/Day) X " + responses['dpw_response']*52 + " Days Per Year";
                    }

                    let total_car_spend_yearly = gas_spending_year + parking_spending_year + (6.94*responses['dpw_response']*52);


                    // Alternate public transportation cost calculation
                    let days_per_month = responses['dpw_response']*4

                    let lirr_zone = lirrZones_reversed[responses['lirr_response']];

                    let train_spending_monthly = Math.min(zoneToCityFares[lirr_zone]['Monthly'], zoneToCityFares[lirr_zone]['One-Way Peak']*days_per_month*2);

                    let train_ticket_type = "";

                    if (train_spending_monthly == zoneToCityFares[lirr_zone]['Monthly']) {
                        train_ticket_type = "monthly";
                    } else {
                        train_ticket_type = "non-monthly (One-Way, Round-Trip, 10-Trip)";
                    }

                    const subway_fare = 2.90;

                    let train_cost_yearly = train_spending_monthly*12 + (subway_fare*2*days_per_month*12);


                    // VISUALIZATION GENERATION

                    const cost_bar_svg = safety_visualizations.append("svg")
                                                                  .attr("id", "cost_bar")
                                                                  .attr("width", "950")
                                                                  .attr("height", "180");

                    const barwidth = cost_bar_svg.attr("width");
                    const barheight = cost_bar_svg.attr("height");
                    const margin = {top: 10, right: 10, bottom: 10, left: 240};
                    const chartWidth = barwidth - margin.left - margin.right;
                    const chartHeight = barheight - margin.top - margin.bottom;

                    const costScale = d3.scaleLinear()
                                        .domain([0, d3.max([total_car_spend_yearly, train_cost_yearly])])
                                        .range([0, chartWidth]);


                    const costBarArea = cost_bar_svg.append("g")
                                                            .attr("transform", `translate(${margin.left}, ${margin.top})`);

                    const driveCostBar = costBarArea.append("rect")
                                                    .attr('x', 0)
                                                    .attr('y', 20)
                                                    .attr('width', costScale(total_car_spend_yearly))
                                                    .attr('height', 50)
                                                    .style('fill', 'red')
                                                    .style('opacity', 0.5);

                    costBarArea.append('text')
                               .attr('x', -5)
                               .attr('y', 45)
                               .attr('text-anchor', 'end')
                               .attr('dominant-baseline', 'middle')
                               .text('Current Spending');


                    const trainCostBar = costBarArea.append("rect")
                                                    .attr('x', 0)
                                                    .attr('y', 90)
                                                    .attr('width', costScale(train_cost_yearly))
                                                    .attr('height', 50)
                                                    .style('fill', 'green');

                    costBarArea.append('text')
                               .attr('x', -5)
                               .attr('y', 115)
                               .attr('text-anchor', 'end')
                               .attr('dominant-baseline', 'middle')
                               .text('Potential Using Public Transit');

                    costBarArea.append('line')
                               .attr('x1', 0)
                               .attr('x2', 0)
                               .attr('y1', 0)
                               .attr('y2', 160)
                               .attr('stroke', 'black')
                               .attr('stroke-width', 2);

                    // Driving commute cost
                    safety_visualizations.append("h2").text("How much does your commute currently cost?");

                    safety_visualizations.append("p").text("Based on your nearest LIRR station (" + responses['lirr_response'] + ") work is about " + work_distance + " miles away.");

                    safety_visualizations.append("p").text("Driving that distance back and forth " + responses['dpw_response'] + " days per week, you are commuting " + work_distance*responses['dpw_response']*2*52 + " miles per year!");

                    safety_visualizations.append("p").text("At " + gas_mileage + " MPG, your " + responses["car_year_response"] + ' ' + responses["car_make_response"] + ' ' + responses["car_model_response"] + " needs " + ((work_distance*responses['dpw_response']*2*52)/gas_mileage).toLocaleString('en-US', { maximumFractionDigits: 2 }) + " gallons of gas per year for that commute!").style("margin-bottom", "30px");

                    const gas_cost_div = safety_visualizations.append("div").attr("class", "cost_component_div");
                    gas_cost_div.append("img").attr("src", "images/gas-station.png").style('height', '100px').style('width', 'auto');
                    gas_cost_div.append("p").html("Gas: " + ((work_distance*responses['dpw_response']*2*52)/gas_mileage).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " gallons X $3.30 (Average Gas Price 2024)<br>= <strong>$" + gas_spending_year.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "</strong>");
                    
                    safety_visualizations.append("p").attr('class', 'plus_sign').text("+");

                    const parking_cost_div = safety_visualizations.append("div").attr("class", "cost_component_div");
                    parking_cost_div.append("img").attr("src", "images/parking.png").style('height', '100px').style('width', 'auto');
                    parking_cost_div.append("p").html("Parking: " + parking_mode + "<br>= <strong>$" + parking_spending_year.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "</strong>");
                    
                    safety_visualizations.append("p").attr('class', 'plus_sign').text("+");
                    
                    const tolls_cost_div = safety_visualizations.append("div").attr("class", "cost_component_div");
                    tolls_cost_div.append("img").attr("src", "images/barrier.png").style('height', '100px').style('width', 'auto');
                    tolls_cost_div.append("p").html("Tolls: $6.94 (Toll to Enter NYC) X " + responses['dpw_response']*52 + " Days Per Year<br>= <strong>$" + (6.94*responses['dpw_response']*52).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "</strong>");
                    

                    safety_visualizations.append('h3').attr("class", "cost_final").html("= $" + total_car_spend_yearly.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "<br>spent driving to and from work in 2024");


                    // Public Transportation Cost
                    safety_visualizations.append("h2").text("How much could you save per year using public transportation?");

                    safety_visualizations.append("p").html("Since you commute " + responses['dpw_response'] + " days per week, your cheapest ticket option on the Long Island Rail Road (LIRR) would be a<br><strong>" + train_ticket_type + "</strong> ticket.").style('text-align', 'center').style('margin-bottom', '30px');

                    const lirr_cost_div = safety_visualizations.append("div").attr("class", "cost_component_div");
                    lirr_cost_div.append('img').attr('src', 'images/train.png').style('height', '100px').style('width', 'auto');

                    if (train_ticket_type == "monthly") {
                        lirr_cost_div.append('p').html("LIRR: " + train_spending_monthly + " Monthly Ticket X 12 Months<br>= <strong>$" + (train_spending_monthly*12).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "</strong>");
                    } else {
                        lirr_cost_div.append('p').html("LIRR: $" + zoneToCityFares[lirr_zone]['One-Way Peak']*2 + " Round-Trip Ticket X " + responses['dpw_response']*4 + " Days Per Month X 12 Months<br>= <strong>$" + (train_spending_monthly*12).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "</strong>");
                    }

                    safety_visualizations.append("p").attr('class', 'plus_sign').text("+");

                    const subway_cost_div = safety_visualizations.append("div").attr("class", "cost_component_div");
                    subway_cost_div.append('img').attr('src', 'images/seoul-metro-logo.png').style('height', '100px').style('width', 'auto');
                    subway_cost_div.append('p').html('Subway: $' + subway_fare.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " X 2 X " + responses['dpw_response']*52 + " Days Per Year<br>= <strong>$" + (subway_fare*2*days_per_month*12).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "</strong>");

                    safety_visualizations.append('h3').attr("class", "cost_final").html("= $" + train_cost_yearly.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "<br>to commute using public transportation");


                    // Final Result
                    if (total_car_spend_yearly < train_cost_yearly) {
                        safety_visualizations.append('h3').text('According to our calculations, you are using the most economical transportation option! However, be aware that these calculations do not account for significant expenses such as loan/lease payments or maintenance costs. Feel free to add these to our estimate and compare again if applicable.')
                    } else {
                        safety_visualizations.append('h3').text('According to our calculations, you could be saving $' + (total_car_spend_yearly-train_cost_yearly).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' per year using public transportation! Also note that these calculations do not account for significant expenses such as loan/lease payments or maintenance costs. Feel free to add these to our estimate and compare again if applicable.').style("width", "700px")
                    }

                    safety_visualizations.append('p').text("")


                    const restart_button_div = safety_visualizations.append('div').attr('class', 'safety_restart_button')
                                                                              .attr("id", "restart")
                                                                              .attr("name", "restart")
                                                                              .on("click", function () {
                                                                                window.scrollTo({ top: 0, behavior: 'smooth' });
                                                                                generate_form();
                                                                              });

                    restart_button_div.append('img').attr('src', 'images/restart.png').attr('height', '12px');
                    restart_button_div.append('text').text('Restart');
                }

                function safety_section (responses) {

                    body.select('#form_header').remove();

                    body.select('#form').remove();

                    body.selectAll('div').remove();

                    const safety_visualizations = body.append('div').attr('id', 'safety').attr('class', 'safety');
                    // Clear out in case user is redoing the form
                    safety_visualizations.html("");

                    const safety_header = safety_visualizations.append('div').attr('class', 'safety_header');

                    safety_header.append('img').attr('src', 'images/collision.png').style('height', '38px');
                    safety_header.append("h1").text("Section 1: Safety");
                    safety_header.append('img').attr('src', 'images/collision.png').style('height', '38px');

                    safety_visualizations.append("p").attr('class', 'section_intro').text("While hopping in the car every morning probably feels like routine, it is important to remember that taking a drive is taking a risk. Car accidents happen every day during your commute, and you aren't immune to them. Take a look:")

                    // Bar graph that depicts accidents by time of day, and highlights times selected by user
                    safety_visualizations.append("h2").text("NYC Car Accidents 2024 by Time of Day");

                    const accident_bar_div = safety_visualizations.append("div").attr('class', 'accident_bar_div');

                    const accident_bar_svg = accident_bar_div.append("svg")
                                                                  .attr("id", "accident_bar")
                                                                  .attr("width", "1000")
                                                                  .attr("height", "550");

                    const barwidth = accident_bar_svg.attr("width");
                    const barheight = accident_bar_svg.attr("height");
                    const margin = {top: 10, right: 15, bottom: 60, left: 80};
                    const chartWidth = barwidth - margin.left - margin.right;
                    const chartHeight = barheight - margin.top - margin.bottom;

                    const hours = collisions_crashes.map(d => d["CRASH.DATE"].getHours());

                    var accident_histogram = d3.histogram()
                                               .domain([0, 24])
                                               .thresholds(d3.range(0, 25));

                    const time_bins = accident_histogram(hours);

                    const timeScale = d3.scaleLinear()
                                        .domain([0, 24])
                                        .range([0, chartWidth]);

                    var accident_countScale = d3.scaleLinear()
                                                .domain([0, d3.max(time_bins,d => d.length)])
                                                .range([chartHeight, 0]);

                    const accidentBarArea = accident_bar_svg.append("g")
                                    .attr("transform", `translate(${margin.left}, ${margin.top})`);

                    accident_bar_svg.append("g")
                        .attr("class", "x axis")
                        .attr("transform",`translate(${margin.left},${chartHeight+margin.top})`)
                        .call(d3.axisBottom(timeScale)
                                .tickValues(d3.range(0, 24))
                                .tickFormat(d => {
                                    const hour = d % 12 === 0 ? 12 : d % 12;
                                    const ampm = d < 12 ? "AM" : "PM";
                                    return `${hour} ${ampm}`;
                                }));

                    accident_bar_svg.append('text')
                                    .attr('x', (chartWidth/2)+margin.left)
                                    .attr('y', chartHeight+margin.top+40)
                                    .attr('text-anchor', 'middle')
                                    .text('Time of Day');

                    accident_bar_svg.append('text')
                                    .attr('transform', `rotate(-90)`)
                                    .attr('x', -((chartHeight + margin.top) / 2))
                                    .attr('y', 25)
                                    .attr('text-anchor', 'middle')
                                    .text('# Accidents in 2024');

                    accident_bar_svg.append("g")
                        .attr("transform",`translate(${margin.left},${margin.top})`)
                        .call(d3.axisLeft(accident_countScale));


                    const accident_bars = accidentBarArea.selectAll("rect")
                                    .data(time_bins)
                                    .enter()
                                    .append("rect")
                                    .attr("x", d => timeScale(d.x0))
                                    .attr("y", d => accident_countScale(d.length))
                                    .attr("width", d => timeScale(d.x1) - timeScale(d.x0))
                                    .attr("height", d => chartHeight - accident_countScale(d.length))
                                    .style("fill", "#807e7e");


                    const go_hour = parseInt(responses.start_commute_response.split(":")[0]);
                    const leave_hour = parseInt(responses.end_commute_response.split(":")[0]);

                    const highlight_start = timeScale(go_hour);
                    const highlight_end = timeScale(leave_hour);

                    accidentBarArea.append("rect")
                                    .attr("x", highlight_start)
                                    .attr("y", 0)
                                    .attr("width", timeScale(highlight_start+1) - timeScale(highlight_start))
                                    .attr("height", chartHeight)
                                    .style("fill", "red")
                                    .style("opacity", 0.3);

                    accidentBarArea.append("rect")
                                    .attr("x", highlight_end)
                                    .attr("y", 0)
                                    .attr("width", timeScale(highlight_end+1) - timeScale(highlight_end))
                                    .attr("height", chartHeight)
                                    .style("fill", "red")
                                    .style("opacity", 0.3);

                    // Value boxes div
                    const safetyValueBoxes = safety_visualizations.append('div').attr('class', 'safety_value_boxes');

                    // Value box that shows the percentage of accidents that happen during user's commute
                    let hours_overlap = hours.filter(d => d === go_hour || d === leave_hour);

                    let percentage_overlap = (hours_overlap.length / hours.length)*100

                    // Value box that shows the total number of accidents in 2024 during their commute time

                    safetyValueBoxes.append('h3').text("In 2024:");
                    safetyValueBoxes.append('p').attr("class", "safety_metric").text(hours_overlap.length.toLocaleString('en-US'));
                    safetyValueBoxes.append('p').html("car accidents in NYC occurred during the times of your commute.<br>That's");

                    safetyValueBoxes.append('p').attr("class", "safety_metric").text(percentage_overlap.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })+"%");
                    safetyValueBoxes.append('p').text("of all accidents in NYC.");

                    safety_visualizations.append('p').text('As you reassess your commuting options, think about these statistics and how they could affect you any given day. Is a slightly faster commute worth it?').style('width', '700px').style('font-size', '20px');

                    // Paragraph explaining general safety stuff

                    const next_to_costs = safety_visualizations.append('div').attr('class', 'safety_button').append("button")
                                         .text("Next Section: Cost")
                                         .on("click", function() {
                                            window.scrollTo({ top: 0, behavior: 'smooth' });
                                            cost_section(responses);
                                         });

                    const restart_button_div = safety_visualizations.append('div').attr('class', 'safety_restart_button')
                                                                              .attr("id", "restart")
                                                                              .attr("name", "restart")
                                                                              .on("click", function () {
                                                                                window.scrollTo({ top: 0, behavior: 'smooth' });
                                                                                generate_form();
                                                                              });

                    restart_button_div.append('img').attr('src', 'images/restart.png').attr('height', '12px');
                    restart_button_div.append('text').text('Restart');
                }




                // FORM GENERATION

                function generate_form() {
                    body.selectAll('div').remove();

                    const intro_photos = body.append('div').attr('class', 'form_section');
                    intro_photos.append('img').attr('src', 'images/midtown-tunnel.jpg').style('height', '460px');
                    intro_photos.append('img').attr('src', 'images/lirr.jpg').style('height', '460px');

                    body.append('h3').attr('id', 'form_header').text("Enter your details for a personalized report:");

                    const form = body.append('form').attr('id', 'form').attr('class', 'form');

                    const dpw_section = form.append('div').attr('class', 'form_section');
                    dpw_section.append("label").attr("for", "dpw").text("How many days per week do you commute to the city?");
                    dpw_section.append("input").attr("type", "number").attr("id", "dpw").attr("name", "dpw").attr("min", "1").attr("max", "7");

                    const start_commute_section = form.append('div').attr('class', 'form_section');
                    start_commute_section.append("label").attr("for", "start_commute").text("What time do you leave for work?");
                    start_commute_section.append("input").attr("type", "time").attr("id", "start_commute").attr("name", "start_commute").attr("step", "3600");

                    const end_commute_section = form.append('div').attr('class', 'form_section');
                    end_commute_section.append("label").attr("for", "end_commute").text("What time do you go home from work?");
                    end_commute_section.append("input").attr("type", "time").attr("id", "end_commute").attr("name", "end_commute").attr("step", "3600");


                    // Form selections

                    const vehicle_info_form = form.append("div").attr("id", "vehicle_info").attr("class", "form_category_section");

                    const lirr_form = form.append("div").attr("id", "lirr").attr("class", "form_section");

                    const error_message = form.append("div").attr("id", "error_message").attr("class", "form_category_section");

                    // Car lookup form generation
                    const vehicle_year_section = vehicle_info_form.append('div').attr('class', 'form_section');

                    vehicle_year_section.append("label").attr("for", "car_year").text("Vehicle year:");

                    vehicle_year_section.append("select").attr("id", "car_year").attr("name", "car_year");

                    const car_year_select = d3.select("#car_year");

                    car_year_select.append("option")
                                        .attr("value", "")
                                        .text("Select Year");

                    years.forEach(d => {
                        car_year_select.append("option")
                                        .attr("value", parseInt(d))
                                        .text(d);
                    });

                    car_year_select.on("change", function() {
                        const selectedYear = d3.select(this).property("value");

                        d3.select("#car_model_label").remove();
                        d3.select("#car_model").remove();

                        d3.select("#car_make_label").remove();
                        d3.select("#car_make").remove();

                        if (selectedYear) {
                            const vehicle_make_section = vehicle_info_form.append('div').attr('class', 'form_section');

                            vehicle_make_section.append("label").attr("for", "car_make").attr("id", "car_make_label").text("\nVehicle Make:")
                            vehicle_make_section.append("select").attr("id", "car_make").attr("name", "car_make");

                            const car_make_select = d3.select("#car_make");

                            car_make_select.append("option")
                                            .attr("value", "")
                                            .text("Select Make");

                            Object.keys(lookup[selectedYear]).sort().forEach(d => {
                                car_make_select.append("option")
                                                .attr("value", d)
                                                .text(d);
                            });

                            car_make_select.on("change", function() {
                                const selectedMake = d3.select(this).property("value");

                                d3.select("#car_model_label").remove();
                                d3.select("#car_model").remove();

                                if (selectedMake) {
                                    const vehicle_model_section = vehicle_info_form.append('div').attr('class', 'form_section');

                                    vehicle_model_section.append("label").attr("for", "car_model").attr("id", "car_model_label").text("\nVehicle Model:")
                                    vehicle_model_section.append("select").attr("id", "car_model").attr("name", "car_model");

                                    const car_model_select = d3.select("#car_model");

                                    car_model_select.append("option")
                                            .attr("value", "")
                                            .text("Select Model");

                                    Object.keys(lookup[selectedYear][selectedMake]).sort().forEach(j => {
                                        car_model_select.append("option")
                                                .attr("value", j)
                                                .text(j);
                                    });
                                }
                            });
                        }
                    });

                    // LIRR form section generation
                    
                    lirr_form.append("label").attr("for", "lirr_station").text("Nearest LIRR Station:");

                    lirr_form.append("select").attr("id", "lirr_station").attr("name", "lirr_station");

                    const lirr_station_select = d3.select("#lirr_station");

                    lirr_station_select.append("option")
                                        .attr("value", "")
                                        .text("Select Station");

                    allStations.forEach(d => {
                        lirr_station_select.append("option")
                                        .attr("value", d)
                                        .text(d);
                    });

                    const submit_button_section = form.append('div').attr('class', 'form_section');

                    const submit_button = submit_button_section.append("button").attr("class", "specific_section").attr("type", "button").attr("id", "submit").attr("name", "submit").text("See Your Report");

                    


                    // Submit button action

                    // select other form elements
                    const dpw_select = d3.select("#dpw");
                    const start_commute_select = d3.select("#start_commute");
                    const end_commute_select = d3.select("#end_commute");

                    

                    submit_button.on("click", function() {

                        error_message.selectAll("p").remove();

                        let errors_list = [];

                        // Get all values from the form
                        const dpw_response = dpw_select.property("value");
                        if (dpw_response == "") {
                            errors_list.push("Days Per Week Commuting");
                        }

                        const start_commute_response = start_commute_select.property("value");
                        if (start_commute_response == "") {
                            errors_list.push("Commute to Work Start Time");
                        }

                        const end_commute_response = end_commute_select.property("value");
                        if (end_commute_response == "") {
                            errors_list.push("Commute Home Start Time");
                        }

                        const car_year_response = car_year_select.property("value");
                        if (car_year_response == "") {
                            errors_list.push("Vehicle Year");
                        }

                        let car_make_response = null;
                        if (!d3.select("#car_make").empty()) {
                            car_make_response = d3.select("#car_make").property("value");
                        }
                        if (car_make_response == "" || car_make_response == null) {
                            errors_list.push("Vehicle Make");
                        }

                        let car_model_response = null;
                        if (!d3.select("#car_model").empty()) {
                            car_model_response = d3.select("#car_model").property("value");
                        }
                        if (car_model_response == "" || car_model_response == null) {
                            errors_list.push("Vehicle Model");
                        }

                        const lirr_response = lirr_station_select.property("value");
                        if (lirr_response == "") {
                            errors_list.push("Nearest LIRR Station");
                        }

                        // If any are null, display message
                        // Otherwise, run the graph generation

                        if (errors_list.length > 0) {
                            error_message.append("p")
                                        .text("Please fill out the following fields: " + errors_list.join(", "));
                        }
                        else {
                            const responses = {
                                "dpw_response": dpw_response, 
                                "start_commute_response": start_commute_response, 
                                "end_commute_response": end_commute_response, 
                                "car_year_response": car_year_response, 
                                "car_make_response": car_make_response, 
                                "car_model_response": car_model_response, 
                                "lirr_response": lirr_response
                            }
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                            safety_section(responses);
                        }
                    });

                }
                generate_form();


            }
            requestData();
        </script>
    </body>
</html>